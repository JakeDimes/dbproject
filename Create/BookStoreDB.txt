--
-- File generated with SQLiteStudio v3.3.3 on Wed Oct 26 18:19:58 2022
-- File Last Modified: Sat Dec 3 15:07:31 2022
-- Text encoding used: System
--
PRAGMA foreign_keys = off;
BEGIN TRANSACTION;

-- Table: Author
CREATE TABLE Author (
    Author_ID    INTEGER      NOT NULL
                              PRIMARY KEY,
    Fname        VARCHAR (30),
    Mname        VARCHAR (15),
    Lname        VARCHAR (30),
    Contact_info VARCHAR (60) 
);


-- Table: Book
CREATE TABLE Book (
    ISBN            VARCHAR (13)   PRIMARY KEY
                                   NOT NULL,
    Pub_Domain      VARCHAR (255)  NOT NULL
                                   REFERENCES Publisher (Web_Domain) ON DELETE NO ACTION,
    Title           VARCHAR (255),
    Year            CHAR (4),
    Price           DECIMAL (6, 2),
    Category        VARCHAR (30),
    Inventory_Count INTEGER        NOT NULL
);

-- Table: Contains
CREATE TABLE Contains (
    B_ISBN   VARCHAR (13) REFERENCES Book (ISBN) 
                          NOT NULL,
    Ord_ID   INTEGER      REFERENCES Purchase (Order_id) 
                          NOT NULL,
    Quantity INTEGER      NOT NULL,
    PRIMARY KEY (
        B_ISBN,
        Ord_ID
    )
);


-- Table: Customer
CREATE TABLE Customer (
    Email        VARCHAR (60) NOT NULL
                              PRIMARY KEY,
    Fname        VARCHAR (30),
    Mname 	 VARCHAR (15),
    Lname        VARCHAR (30),
    Phone_Number CHAR (10) 
);

-- Table: Employee
CREATE TABLE Employee (
    Employee_id  INT            NOT NULL
                                PRIMARY KEY,
    Fname        VARCHAR (30),
    Mname 	 VARCHAR (15),
    Lname        VARCHAR (30),
    Salary       DECIMAL (9, 2),
    Department   VARCHAR (30)   NOT NULL,
    Work_Hours   INTEGER,
    Phone_Number CHAR (10)
);

-- Table: Publisher
CREATE TABLE Publisher (
    Web_Domain     VARCHAR (255)  PRIMARY KEY
                                 NOT NULL,
    Publisher_name VARCHAR (255),
    Address        VARCHAR (30) 
);

-- Table: Purchase
CREATE TABLE Purchase (
    Order_id   		INT          NOT NULL
                        	    PRIMARY KEY,
    Cust_Email 		VARCHAR (60) REFERENCES Customer (Email),
    Purchase_Time 	DATETIME     NOT NULL
);


-- Table: Sells
CREATE TABLE Sells (
    Emp_ID INTEGER REFERENCES Employee (Employee_id) 
                   NOT NULL,
    Ord_ID INTEGER REFERENCES Purchase (Order_id) 
                   NOT NULL,
    PRIMARY KEY (
        Emp_ID,
        Ord_ID
    )
);


-- Table: Writes
CREATE TABLE Writes (
    B_ISBN  VARCHAR (13) REFERENCES Book (ISBN) 
                         NOT NULL,
    Auth_ID INTEGER      REFERENCES AUTHOR (Author_id) 
                         NOT NULL,
    PRIMARY KEY (
        B_ISBN,
        Auth_ID
    )
);

-- This view finds a list of all authors and their most popular book

CREATE VIEW Most_Popular AS  
SELECT ID, BISBN, SumQ
FROM (
SELECT A.Author_ID AS ID, B.ISBN AS BISBN, SUM(Co.Quantity) AS SumQ
FROM Author As A, Book AS B, Writes AS W, Contains AS CO
WHERE A.Author_ID = W.Auth_ID 
	AND B.ISBN = W.B_ISBN
	AND Co.B_ISBN = B.ISBN
GROUP BY B.ISBN
)
Group By ID
Having MAX(SumQ);

-- This view finds how many books each employee has sold.
SELECT		E.Employee_id, E.Fname, E.Lname, SUM(Co.Quantity)
FROM		Employee AS E, Sells as S, Purchase AS P, Contains as Co
WHERE		S.Emp_ID = E.Employee_id
		AND S.Ord_ID = P.Order_id
		AND Co.Ord_ID = P.Order_id
GROUP BY 	E.Employee_id;

-- This view finds the number of books in stock per Publisher

CREATE VIEW Publisher_Stock AS
SELECT 		P.Web_Domain, P.Publisher_name,  SUM(B.Inventory_Count) AS Total_Books
FROM 		Publisher AS P, Book AS B
WHERE 		B.Pub_Domain = P.Web_Domain
GROUP BY 	P.Web_Domain;


COMMIT TRANSACTION;
PRAGMA foreign_keys = on;

